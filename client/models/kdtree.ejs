<style>
  body { font-family: sans-serif; }
  #controls { margin: 8px 0; }
  #controls button {
    padding: 4px 12px;
    margin-right: 4px;
    cursor: pointer;
  }
  #info {
    font-size: 13px;
    color: #555;
    margin-top: 4px;
    min-height: 1.4em;
  }
</style>

<div id="controls">
  <button id="toggle">Pause</button>
  <button id="step" disabled>Step</button>
</div>
<div id="info">Click an agent to inspect it and highlight its neighbors.</div>
<div id="container"></div>
<div id="histogram"></div>
<script>
  utils.seed(1);
  const NEIGHBOR_DISTANCE = 120;
  const [width, height] = [600, 600];
  const environment = new Environment({ width, height });
  const renderer = new CanvasRenderer(environment, {
    background: "#ccc",
    width,
    height,
    interactive: true,
    onSelect(agent) {
      updateInfo(agent);
    }
  });
  renderer.mount("#container");

  let tree;
  let selectedAgent = null;

  // --- Pause / Step controls ---
  const toggleBtn = document.getElementById("toggle");
  const stepBtn = document.getElementById("step");

  toggleBtn.addEventListener("click", () => {
    environment.toggle();
    toggleBtn.textContent = environment.playing ? "Pause" : "Resume";
    stepBtn.disabled = environment.playing;
  });

  stepBtn.addEventListener("click", () => {
    environment.step();
    highlightNeighbors();
  });

  // --- Interactive events ---
  renderer.on("click", (agent) => {
    selectedAgent = agent;
    highlightNeighbors();
  });

  function highlightNeighbors() {
    // Reset all agents to default appearance
    environment.getAgents().forEach(a => {
      a.set("size", 1);
      a.set("color", "black");
    });

    if (selectedAgent) {
      selectedAgent.set("size", 6);
      selectedAgent.set("color", "#0af");
      const neighbors = tree.agentsWithinDistance(selectedAgent, NEIGHBOR_DISTANCE);
      neighbors.forEach(a => {
        a.set("size", 3);
        a.set("color", "#f50");
      });
      // Ensure selected stays on top visually
      selectedAgent.set("size", 6);
    }

    renderer.render();
  }

  function updateInfo(agent) {
    const infoEl = document.getElementById("info");
    if (!agent) {
      infoEl.textContent = "Click an agent to inspect it and highlight its neighbors.";
      selectedAgent = null;
      // Reset appearance
      environment.getAgents().forEach(a => {
        a.set("size", 1);
        a.set("color", "black");
      });
      renderer.render();
      return;
    }
    const neighbors = tree.agentsWithinDistance(agent, NEIGHBOR_DISTANCE);
    const { x, y } = agent.getData();
    infoEl.textContent = `Selected agent at (${x.toFixed(1)}, ${y.toFixed(1)}) â€” ${neighbors.length} neighbor${neighbors.length !== 1 ? "s" : ""} within d=${NEIGHBOR_DISTANCE}`;
  }

  function tick(agent) {
    agent.increment("x", utils.random(0, 1) * 6 - 3);
    agent.increment("y", utils.random(0, 1) * 6 - 3);
  }

  function setup() {
    for (let i = 0; i < 600; i++) {
      const agent = new Agent({
        x: utils.random(0, width),
        y: utils.random(0, height)
      });
      agent.addRule(tick);
      environment.addAgent(agent);
    }
    tree = new KDTree(environment.getAgents(), 2);
    environment.use(tree);
  }

  function run() {
    environment.tick();
    // If there's a selected agent, keep the highlight up to date
    if (selectedAgent) highlightNeighbors();
    requestAnimationFrame(run);
  }

  setup();
  run();
</script>